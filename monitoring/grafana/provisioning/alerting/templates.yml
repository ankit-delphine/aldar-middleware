apiVersion: 1

# ============================================================================
# Grafana Alert Notification Templates
# ============================================================================
#
# Custom templates for formatting alert notifications.
# Templates use Go template syntax with Grafana-specific functions.
# ============================================================================

templates:
  # --------------------------------------------------------------------------
  # Slack Templates
  # --------------------------------------------------------------------------
  - name: slack_alert_title
    template: |
      {{ if eq .Status "firing" }}ðŸ”´{{ else }}âœ…{{ end }} {{ .GroupLabels.alertname }}
      
  - name: slack_alert_message
    template: |
      *Alert*: {{ .GroupLabels.alertname }}
      *Status*: {{ .Status | toUpper }}
      *Severity*: {{ .GroupLabels.severity | toUpper }}
      *Service*: {{ .GroupLabels.service }}
      
      {{ range .Alerts }}
      {{ if .Annotations.summary }}*Summary*: {{ .Annotations.summary }}{{ end }}
      {{ if .Annotations.description }}*Description*: {{ .Annotations.description }}{{ end }}
      {{ if .Annotations.runbook_url }}*Runbook*: {{ .Annotations.runbook_url }}{{ end }}
      
      *Value*: {{ .ValueString }}
      *Started*: {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}
      {{ if .Labels.dashboard_url }}*Dashboard*: {{ .Labels.dashboard_url }}{{ end }}
      {{ end }}

  # --------------------------------------------------------------------------
  # Email Templates
  # --------------------------------------------------------------------------
  - name: email_subject
    template: |
      {{ if eq .Status "firing" }}[FIRING]{{ else }}[RESOLVED]{{ end }} {{ .GroupLabels.alertname }} - {{ .GroupLabels.service }}

  - name: email_body
    template: |
      <html>
      <head>
        <style>
          body { font-family: Arial, sans-serif; }
          .alert { padding: 20px; border-radius: 5px; margin: 10px 0; }
          .critical { background-color: #ffebee; border-left: 5px solid #f44336; }
          .warning { background-color: #fff3e0; border-left: 5px solid #ff9800; }
          .info { background-color: #e3f2fd; border-left: 5px solid #2196f3; }
          .resolved { background-color: #e8f5e9; border-left: 5px solid #4caf50; }
          .label { font-weight: bold; color: #333; }
          .value { color: #666; }
          table { border-collapse: collapse; width: 100%; }
          td { padding: 8px; border-bottom: 1px solid #ddd; }
        </style>
      </head>
      <body>
        <h2>{{ if eq .Status "firing" }}ðŸ”´ Alert Firing{{ else }}âœ… Alert Resolved{{ end }}</h2>
        
        {{ range .Alerts }}
        <div class="alert {{ if eq $.Status "resolved" }}resolved{{ else }}{{ .Labels.severity }}{{ end }}">
          <h3>{{ .Labels.alertname }}</h3>
          
          <table>
            <tr>
              <td class="label">Status:</td>
              <td class="value">{{ $.Status | toUpper }}</td>
            </tr>
            <tr>
              <td class="label">Severity:</td>
              <td class="value">{{ .Labels.severity | toUpper }}</td>
            </tr>
            <tr>
              <td class="label">Service:</td>
              <td class="value">{{ .Labels.service }}</td>
            </tr>
            {{ if .Annotations.summary }}
            <tr>
              <td class="label">Summary:</td>
              <td class="value">{{ .Annotations.summary }}</td>
            </tr>
            {{ end }}
            {{ if .Annotations.description }}
            <tr>
              <td class="label">Description:</td>
              <td class="value">{{ .Annotations.description }}</td>
            </tr>
            {{ end }}
            <tr>
              <td class="label">Value:</td>
              <td class="value">{{ .ValueString }}</td>
            </tr>
            <tr>
              <td class="label">Started:</td>
              <td class="value">{{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}</td>
            </tr>
            {{ if .Annotations.runbook_url }}
            <tr>
              <td class="label">Runbook:</td>
              <td class="value"><a href="{{ .Annotations.runbook_url }}">View Resolution Steps</a></td>
            </tr>
            {{ end }}
            {{ if .Labels.dashboard_url }}
            <tr>
              <td class="label">Dashboard:</td>
              <td class="value"><a href="{{ .Labels.dashboard_url }}">View Dashboard</a></td>
            </tr>
            {{ end }}
          </table>
        </div>
        {{ end }}
        
        <p style="color: #999; font-size: 12px; margin-top: 20px;">
          Generated by AIQ Backend Monitoring System
        </p>
      </body>
      </html>

  # --------------------------------------------------------------------------
  # PagerDuty Templates
  # --------------------------------------------------------------------------
  - name: pagerduty_description
    template: |
      {{ .GroupLabels.alertname }}: {{ .Annotations.summary }}

  - name: pagerduty_details
    template: |
      {{ range .Alerts }}
      Alert: {{ .Labels.alertname }}
      Severity: {{ .Labels.severity }}
      Service: {{ .Labels.service }}
      {{ if .Annotations.description }}Description: {{ .Annotations.description }}{{ end }}
      Value: {{ .ValueString }}
      Started: {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}
      {{ if .Annotations.runbook_url }}Runbook: {{ .Annotations.runbook_url }}{{ end }}
      {{ end }}

  # --------------------------------------------------------------------------
  # Microsoft Teams Templates
  # --------------------------------------------------------------------------
  - name: teams_message
    template: |
      {
        "@type": "MessageCard",
        "@context": "http://schema.org/extensions",
        "themeColor": "{{ if eq .Status "firing" }}{{ if eq .GroupLabels.severity "critical" }}d32f2f{{ else if eq .GroupLabels.severity "warning" }}f57c00{{ else }}1976d2{{ end }}{{ else }}388e3c{{ end }}",
        "summary": "{{ .GroupLabels.alertname }}",
        "sections": [{
          "activityTitle": "{{ if eq .Status "firing" }}ðŸ”´{{ else }}âœ…{{ end }} {{ .GroupLabels.alertname }}",
          "activitySubtitle": "{{ .Status | toUpper }} - {{ .GroupLabels.severity | toUpper }}",
          "facts": [
            {{ range $i, $alert := .Alerts }}
            {{ if $i }},{{ end }}
            {
              "name": "Service",
              "value": "{{ $alert.Labels.service }}"
            },
            {{ if $alert.Annotations.description }}
            {
              "name": "Description",
              "value": "{{ $alert.Annotations.description }}"
            },
            {{ end }}
            {
              "name": "Value",
              "value": "{{ $alert.ValueString }}"
            },
            {
              "name": "Started",
              "value": "{{ $alert.StartsAt.Format "2006-01-02 15:04:05 MST" }}"
            }
            {{ end }}
          ],
          "markdown": true
        }],
        "potentialAction": [
          {{ range .Alerts }}
          {{ if .Annotations.runbook_url }}
          {
            "@type": "OpenUri",
            "name": "View Runbook",
            "targets": [{
              "os": "default",
              "uri": "{{ .Annotations.runbook_url }}"
            }]
          }
          {{ end }}
          {{ end }}
        ]
      }

  # --------------------------------------------------------------------------
  # Webhook (Generic JSON) Template
  # --------------------------------------------------------------------------
  - name: webhook_payload
    template: |
      {
        "status": "{{ .Status }}",
        "alertname": "{{ .GroupLabels.alertname }}",
        "severity": "{{ .GroupLabels.severity }}",
        "service": "{{ .GroupLabels.service }}",
        "timestamp": "{{ now.UTC.Format "2006-01-02T15:04:05Z07:00" }}",
        "alerts": [
          {{ range $i, $alert := .Alerts }}
          {{ if $i }},{{ end }}
          {
            "labels": {
              {{ range $k, $v := $alert.Labels }}
              "{{ $k }}": "{{ $v }}"{{ if ne $k (last $alert.Labels) }},{{ end }}
              {{ end }}
            },
            "annotations": {
              {{ range $k, $v := $alert.Annotations }}
              "{{ $k }}": "{{ $v }}"{{ if ne $k (last $alert.Annotations) }},{{ end }}
              {{ end }}
            },
            "startsAt": "{{ $alert.StartsAt.Format "2006-01-02T15:04:05Z07:00" }}",
            {{ if $alert.EndsAt }}
            "endsAt": "{{ $alert.EndsAt.Format "2006-01-02T15:04:05Z07:00" }}",
            {{ end }}
            "value": "{{ $alert.ValueString }}",
            "fingerprint": "{{ $alert.Fingerprint }}"
          }
          {{ end }}
        ]
      }

  # --------------------------------------------------------------------------
  # Discord Template
  # --------------------------------------------------------------------------
  - name: discord_message
    template: |
      **{{ if eq .Status "firing" }}ðŸ”´ ALERT FIRING{{ else }}âœ… ALERT RESOLVED{{ end }}**
      
      **Alert**: {{ .GroupLabels.alertname }}
      **Status**: {{ .Status | toUpper }}
      **Severity**: {{ .GroupLabels.severity | toUpper }}
      **Service**: {{ .GroupLabels.service }}
      
      {{ range .Alerts }}
      {{ if .Annotations.summary }}**Summary**: {{ .Annotations.summary }}{{ end }}
      {{ if .Annotations.description }}**Description**: {{ .Annotations.description }}{{ end }}
      
      **Value**: `{{ .ValueString }}`
      **Started**: {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}
      
      {{ if .Annotations.runbook_url }}[ðŸ“– View Runbook]({{ .Annotations.runbook_url }}){{ end }}
      {{ if .Labels.dashboard_url }}[ðŸ“Š View Dashboard]({{ .Labels.dashboard_url }}){{ end }}
      {{ end }}
      
      ---
      *AIQ Backend Monitoring*

# ============================================================================
# TEMPLATE USAGE NOTES
# ============================================================================
#
# Available Variables:
# - .Status: "firing" or "resolved"
# - .GroupLabels: Labels used for grouping (map)
# - .CommonLabels: Labels common to all alerts (map)
# - .CommonAnnotations: Annotations common to all alerts (map)
# - .Alerts: Array of alert objects
#
# Alert Object Fields:
# - .Labels: Alert labels (map)
# - .Annotations: Alert annotations (map)
# - .StartsAt: Alert start time
# - .EndsAt: Alert end time (if resolved)
# - .ValueString: Formatted metric value
# - .Fingerprint: Unique alert identifier
#
# Template Functions:
# - toUpper: Convert to uppercase
# - toLower: Convert to lowercase
# - title: Title case
# - now: Current time
# - humanize: Format numbers
# - humanizeDuration: Format duration
#
# Using Templates in Contact Points:
# 
# In contact_points.yml:
#   settings:
#     title: '{{ template "slack_alert_title" . }}'
#     text: '{{ template "slack_alert_message" . }}'
#
# ============================================================================