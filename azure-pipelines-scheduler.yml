# Azure DevOps BUILD Pipeline
# Only builds Docker images and pushes to ACR
# Deploy to AKS happens in Release Pipeline
 
trigger:
  branches:
    include:
      - main
      - development
  paths:
    exclude:
      - README.md
      - '*.md'
      - docs/*
 
variables:
  # Azure Container Registry
  - group: aldar-middleware-variables
  - name: dockerRegistryServiceConnection
    value: 'AIO-SUB-ACR-CON'
  - name: imageRepository
    value: 'aldar-middleware'
  - name: containerRegistry
    value: 'acradqaioshared01.azurecr.io'
  - name: dockerfilePath
    value: '$(Build.SourcesDirectory)'
  - name: tag
    value: '$(Build.BuildId)'
  - name: vmImageName
    value: 'ubuntu-latest'
 
stages:
- stage: Test
  displayName: Run Tests
  jobs:
  - job: Test
    displayName: Run Tests
    pool:
      name: AI-Orchestration-pool
      vmImage: $(vmImageName)
    
    steps:
    - checkout: self
    
    - task: Bash@3
      displayName: 'Install Poetry'
      inputs:
        targetType: 'inline'
        script: |
          set -euo pipefail
 
          # Install Poetry
          curl -sSL https://install.python-poetry.org | python3 -
 
          # Add Poetry to PATH
          export PATH="$HOME/.local/bin:$PATH"
          echo "##vso[task.prependpath]$HOME/.local/bin"
 
          # Verify installation
          poetry --version
   
    - task: Bash@3
      displayName: 'Install Dependencies with Poetry (virtualenv)'
      inputs:
        targetType: 'inline'
        script: |
          # Remove config that causes install into system python
          poetry config --unset virtualenvs.create
          poetry install --no-interaction --no-root --with dev
        
    - task: Bash@3
      displayName: 'Run Tests'
      inputs:
        targetType: 'inline'
        script: |
          set -euo pipefail
 
          # Ensure project root is on PYTHONPATH so your package can be imported
          export PYTHONPATH=$(pwd)
          echo "PYTHONPATH=$PYTHONPATH"
 
          # Debug: show import path and check package import
          poetry run python -c "import sys; print('sys.path =', sys.path)"
          poetry run python -c "import aldar_middleware; print('aldar_middleware import OK:', aldar_middleware)"
 
          # Run pytest via python -m pytest (safer for import paths)
          poetry run python -m pytest tests/ -v --cov=aldar_middleware --cov-report=xml --cov-report=html --junitxml=junit.xml
      continueOnError: true
 
    - task: PublishTestResults@2
      displayName: 'Publish Test Results'
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/junit.xml'
        testRunTitle: 'Test Results'
      condition: always()
 
    - task: PublishCodeCoverageResults@2
      displayName: 'Publish Code Coverage'
      inputs:
        codeCoverageTool: 'Cobertura'
        summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/coverage.xml'
        pathToSources: '$(Build.SourcesDirectory)'
      condition: always()
 
 
- stage: Build
  displayName: Build Docker Images
  dependsOn: Test
  condition: succeeded()
  jobs:
  - job: Build
    displayName: Build and Push Docker Images
    pool:
      name: AI-Orchestration-pool
      vmImage: $(vmImageName)
    
    steps:
    - checkout: self
    
 
    - task: Docker@2
      displayName: 'Build and Push Worker'
      inputs:
        containerRegistry: $(dockerRegistryServiceConnection)
        repository: $(imageRepository)-worker
        command: buildAndPush
        Dockerfile: Dockerfile.worker
        tags: |
          $(tag)
          latest
    
    - task: Docker@2
      displayName: 'Build and Push Beat'
      inputs:
        containerRegistry: $(dockerRegistryServiceConnection)
        repository: $(imageRepository)-beat
        command: buildAndPush
        Dockerfile: Dockerfile.beat
        tags: |
          $(tag)
          latest
    
    - task: Docker@2
      displayName: 'Build and Push Flower'
      inputs:
        containerRegistry: $(dockerRegistryServiceConnection)
        repository: $(imageRepository)-flower
        command: buildAndPush
        Dockerfile: Dockerfile.flower
        tags: |
          $(tag)
          latest
    
    - task: Bash@3
      displayName: 'Output Build Artifacts'
      inputs:
        targetType: 'inline'
        script: |
          echo "##vso[task.setvariable variable=ImageTag]$(tag)"
          echo "##vso[task.setvariable variable=ImageRepository]$(imageRepository)"
          echo "##vso[task.setvariable variable=ContainerRegistry]$(containerRegistry)"
          echo "Built images:"
          echo "- $(containerRegistry)/$(imageRepository)-worker:$(tag)"
          echo "- $(containerRegistry)/$(imageRepository)-beat:$(tag)"
          echo "- $(containerRegistry)/$(imageRepository)-flower:$(tag)"